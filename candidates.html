<div class="card">
    <h3>üìä –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ Google Forms</h3>
    <button onclick="loadFromSheets()" class="btn-primary">üîÑ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞–Ω—ñ –∑ —Ç–∞–±–ª–∏—Ü—ñ</button>
    <p style="color: #888; font-size: 0.9rem; margin-top: 10px;">
        –¢–∞–±–ª–∏—Ü—è: https://docs.google.com/spreadsheets/d/1aVGnm54JVNr5nPKfk3sqECy1Pi8Fb3FXojC3IKzkOhU/
    </p>
</div>

<script>
async function loadFromSheets() {
    const SHEET_ID = '1aVGnm54JVNr5nPKfk3sqECy1Pi8Fb3FXojC3IKzkOhU';
    
    try {
        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;
        const response = await fetch(url);
        const text = await response.text();
        const json = JSON.parse(text.substring(47).slice(0, -2));
        
        if (json.table.rows.length > 0) {
            processSheetData(json.table);
            alert(`–£—Å–ø—ñ—à–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ ${json.table.rows.length - 1} –∫–∞–Ω–¥–∏–¥–∞—Ç—ñ–≤!`);
        } else {
            alert('–¢–∞–±–ª–∏—Ü—è –ø–æ—Ä–æ–∂–Ω—è –∞–±–æ –Ω–µ–º–∞—î –¥–∞–Ω–∏—Ö');
        }
    } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è:', error);
        alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞–Ω—ñ. –ú–æ–∂–ª–∏–≤–æ, –ø—Ä–æ–±–ª–µ–º–∞ –∑ –¥–æ—Å—Ç—É–ø–æ–º.');
    }
}

function processSheetData(table) {
    const rows = table.rows;
    
    // –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ –ø–µ—Ä—à–∏–π —Ä—è–¥–æ–∫ (–∑–∞–≥–æ–ª–æ–≤–∫–∏)
    for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        const cells = row.c;
        
        // –°—Ç–≤–æ—Ä—é—î–º–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –∑ –¥–∞–Ω–∏—Ö –∫–æ–º—ñ—Ä–æ–∫
        // –ü—Ä–∏–ø—É—Å–∫–∞—î–º–æ —Å—Ç—Ä—É–∫—Ç—É—Ä—É: –ß–∞—Å | –Ü–º'—è | Discord | –ü–æ—à—Ç–∞ | –Ü–Ω—à–µ...
        const candidate = {
            id: Date.now() + i,
            name: cells[1] ? cells[1].v : '–ë–µ–∑ —ñ–º–µ–Ω—ñ',
            discord: cells[2] ? cells[2].v : '–ù–µ –≤–∫–∞–∑–∞–Ω–æ',
            email: cells[3] ? cells[3].v : '',
            status: 'new',
            dateAdded: cells[0] ? new Date(cells[0].v).toISOString() : new Date().toISOString(),
            source: 'google_forms'
        };
        
        // –î–æ–¥–∞—î–º–æ –≤—Å—ñ –¥–∞–Ω—ñ –∑ —Ñ–æ—Ä–º–∏
        if (table.cols.length > 4) {
            candidate.additionalData = {};
            for (let j = 4; j < table.cols.length; j++) {
                if (cells[j] && table.cols[j]) {
                    const fieldName = table.cols[j].label || `field_${j}`;
                    candidate.additionalData[fieldName] = cells[j].v;
                }
            }
        }
        
        // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞
        saveCandidate(candidate);
    }
    
    // –û–Ω–æ–≤–ª—é—î–º–æ —Å–ø–∏—Å–æ–∫
    if (typeof renderCandidates === 'function') {
        renderCandidates();
    }
}

function saveCandidate(candidate) {
    let candidates = JSON.parse(localStorage.getItem('candidates')) || [];
    
    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –Ω–µ–º–∞—î –≤–∂–µ —Ç–∞–∫–æ–≥–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞
    const exists = candidates.some(c => 
        c.name === candidate.name && c.discord === candidate.discord
    );
    
    if (!exists) {
        candidates.push(candidate);
        localStorage.setItem('candidates', JSON.stringify(candidates));
    }
}
</script>
